<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý và Cập nhật Điểm Học sinh</title>
    <!-- Tải Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải Font Awesome cho icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        // Cấu hình Tailwind CSS, đảm bảo font chữ hiển thị tiếng Việt tốt
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'],
                    },
                    colors: {
                        'primary': '#6E79EC', // Màu tím chủ đạo
                        'secondary': '#58E6D9', // Màu xanh lam phụ
                        'danger': '#FF3B30',
                        'success': '#34C759',
                    }
                }
            }
        }
    </script>
    <style>
        /* CSS tùy chỉnh cho bảng cố định */
        .sticky-header th { position: sticky; top: 0; z-index: 10; background-color: #f9fafb; }
        /* Tùy chỉnh màu flash messages */
        .flashes { list-style: none; padding: 0; margin-bottom: 1.5rem; }
        .flashes li { padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; font-weight: 600; }
        .success-msg { background-color: #d1fae5; border: 1px solid #34d399; color: #065f46; }
        .error-msg, .warning-msg { background-color: #fee2e2; border: 1px solid #f87171; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-gray-900">
                <i class="fas fa-edit text-primary mr-2"></i> QUẢN LÝ ĐIỂM HỌC SINH
            </h1>
        </header>
        
        <!-- Nút điều hướng -->
        <div class="mb-6 flex justify-between items-center">
            <a href="{{ url_for('index') }}" class="inline-flex items-center text-gray-600 hover:text-gray-900 font-medium transition duration-150">
                <i class="fas fa-arrow-left mr-2"></i> Quay lại trang Tải lên
            </a>
            <a href="{{ url_for('report') }}" class="inline-flex items-center bg-secondary hover:bg-teal-500 text-gray-900 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                <i class="fas fa-chart-bar mr-2"></i> Xem Báo cáo Tổng hợp
            </a>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes max-w-4xl mx-auto">
                {% for category, message in messages %}
                    <li class="{{ category }}-msg shadow-md" role="alert"><i class="fas fa-info-circle mr-2"></i> {{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <!-- Khu vực Thêm/Cập nhật Điểm -->
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl mb-10 border-t-8 border-primary/50 max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-plus-circle text-primary mr-3"></i> Thêm/Cập nhật Điểm
            </h2>
            
            <form action="{{ url_for('add_score') }}" method="post" class="space-y-4">
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" name="name_new" placeholder="Tên học sinh (Nhập thủ công)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary shadow-sm" required>
                    
                    <select name="grade" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white shadow-sm" required>
                        <option value="">-- Khối --</option>
                        {% for grade in grades %}
                        <option value="{{ grade }}">{{ grade }}</option>
                        {% endfor %}
                    </select>
                    
                    <select name="class" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white shadow-sm" required>
                        <option value="">-- Lớp --</option>
                        {% for class in classes %}
                        <option value="{{ class }}">{{ class }}</option>
                        {% endfor %}
                    </select>

                    <select name="subject" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white shadow-sm" required>
                        <option value="">-- Môn --</option>
                        {% for subject in subjects %}
                        <option value="{{ subject }}">{{ subject }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select name="semester" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white shadow-sm" required>
                        <option value="">-- Học kỳ --</option>
                        {% for semester in semesters %}
                        <option value="{{ semester }}">{{ semester }}</option>
                        {% endfor %}
                    </select>
                    
                    <select name="diem_column" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white font-semibold shadow-sm" required>
                        <option value="">-- Chọn CỘT ĐIỂM --</option>
                        <option value="TX1">TX1 (HS 1)</option>
                        <option value="TX2">TX2 (HS 1)</option>
                        <option value="TX3">TX3 (HS 1)</option>
                        <option value="TX4">TX4 (HS 1)</option>
                        <option value="GK">Giữa kỳ (HS 2)</option>
                        <option value="CK">Cuối kỳ (HS 3)</option>
                    </select>
                    
                    <input type="number" step="0.1" min="0" max="10" name="diem_value" placeholder="Nhập điểm (0.0 - 10.0)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary shadow-sm" required>
                </div>
                
                <div class="pt-4">
                    <button type="submit" class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-[1.01]">
                        <i class="fas fa-upload mr-2"></i> Thêm/Cập nhật Điểm
                    </button>
                </div>
            </form>
        </div>


        <!-- DANH SÁCH ĐIỂM CHI TIẾT (Bảng Dữ liệu) -->
        <h2 class="text-2xl font-bold text-gray-800 mt-10 mb-6 border-b pb-2">DANH SÁCH ĐIỂM CHI TIẾT</h2>
        <p class="text-gray-500 mb-4 text-sm"><i class="fas fa-sort-amount-down-alt"></i> Bảng này được sắp xếp theo **Khối -> Lớp -> Môn**.</p>
        
        <div class="bg-white p-6 rounded-2xl shadow-xl overflow-x-auto">
            <div class="max-h-[70vh] overflow-y-auto">
                {% if df.empty %}
                    <div class="text-center py-10">
                        <i class="fas fa-info-circle text-4xl text-primary mb-4"></i>
                        <p class="text-gray-600 font-medium">Chưa có dữ liệu điểm nào được tải lên hoặc thêm vào.</p>
                    </div>
                {% else %}
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky-header">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">Tên</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">Khối</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">Lớp</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">Môn</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">HK</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">TX1</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">TX2</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">TX3</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">TX4</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">GK</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">CK</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for _, row in df.iterrows() %}
                        <tr class="hover:bg-blue-50 transition duration-100">
                            <td class="px-6 py-3 whitespace-nowrap text-sm font-semibold text-gray-900">{{ row['Tên'] }}</td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700">{{ row['Khối'] }}</td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700">{{ row['Lớp'] }}</td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-primary font-medium">{{ row['Môn'] }}</td>
                            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">{{ row['HK'] }}</td>
                            
                            {% for col in ['TX1', 'TX2', 'TX3', 'TX4', 'GK', 'CK'] %}
                                {% set score = row[col] %}
                                {% set is_ck_gk = col == 'GK' or col == 'CK' %}
                                <td class="px-6 py-3 whitespace-nowrap text-sm 
                                    {% if score is not none and score|string not in ['nan', '<NA>'] and score|float < 5.0 %}text-danger font-bold
                                    {% elif score is not none and score|string not in ['nan', '<NA>'] and score|float >= 5.0 %}text-success
                                    {% endif %} 
                                    {% if is_ck_gk %}font-bold{% endif %}
                                ">
                                    {# Kiểm tra 'nan' hoặc '<NA>' trước khi gọi float #}
                                    {{ "{:.1f}".format(score|float) if score is not none and score|string not in ['nan', '<NA>'] else '-' }}
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
            </div>
        </div>
        
    </div>
</body>
</html>
